# AuthModule 认证模块快速理解

## 📌 核心定位
向娱拍 React Native App 的**用户认证模块**，提供完整的登录、注册和密码管理功能。

**技术栈**: React Native + Expo + TypeScript + Zustand

## 🎯 主要功能
- **密码登录**（手机号+密码）
- **验证码登录**（SMS 自动注册）
- **忘记密码**（3 步重置流程）
- **自动登录**（Token 刷新机制）
- **多地区支持**（+86/+1/+44等）
- **路由守卫**（登录状态保护）

## 🏗️ 技术栈
- React Native 0.72+
- Expo SDK
- TypeScript（严格模式）
- Zustand（状态管理）
- Axios（HTTP 客户端）
- Expo SecureStore（敏感数据存储）
- React Navigation（路由管理）

## 📁 核心目录结构
```
AuthModule/
├── api/
│   └── authApi.ts                    # 认证 API 服务（登录/注册/Token 刷新）
├── config/
│   ├── routeWhitelist.ts             # 路由白名单配置
│   └── testAccounts.ts               # 测试账号配置
├── data/
│   └── countries.ts                  # 国家地区数据（+86/+1/+44等）
├── hooks/
│   ├── useAuthInitialization.ts      # 认证初始化 Hook
│   └── useRouteGuard.ts              # 路由守卫 Hook
├── stores/
│   ├── authStore.ts                  # 认证主状态（Token/用户信息）
│   ├── authFlowStore.ts              # 认证流程状态
│   ├── authDataStore.ts              # 认证数据状态
│   └── authUIStore.ts                # 认证 UI 状态
├── utils/
│   ├── credentialStorage.ts          # 凭证存储（SecureStore）
│   └── debugLogger.ts                # 调试日志工具
├── LoginMainPage/                    # 登录主页面
│   ├── index.tsx                     # 页面主文件
│   ├── types.ts                      # 类型定义
│   ├── constants.ts                  # 常量配置
│   ├── styles.ts                     # 样式工具
│   ├── useLoginMainPage.ts           # 状态管理 Hook
│   ├── ActionButtonArea/             # 登录按钮区域
│   ├── AgreementArea/                # 协议勾选区域
│   ├── AuthInputArea/                # 认证输入区域
│   ├── AuxiliaryArea/                # 辅助操作区域
│   ├── CodeInputArea/                # 验证码输入区域
│   ├── PasswordInputArea/            # 密码输入区域
│   ├── PhoneInputArea/               # 手机号输入区域
│   ├── RegionSelectModal/            # 地区选择模态框
│   └── TopWelcomeArea/               # 顶部欢迎区域
├── ForgotPasswordPage/               # 忘记密码页面
├── ResetPasswordPage/                # 重置密码页面
└── SharedComponents/                 # 共享组件
    └── Layout/                       # 布局组件
        ├── AuthKeyboardAvoid/        # 键盘避让
        └── AuthSafeArea/             # 安全区域
```

## 🗺️ 页面导航流程

### 页面清单

| 页面 | 路由 | 组件 | 状态 |
|------|------|------|------|
| **登录主页** | `/auth/login` | `LoginMainPage` | ✅ 已实现 |
| **忘记密码** | `/auth/forgot-password` | `ForgotPasswordPage` | ✅ 已实现 |
| **重置密码** | `/auth/reset-password` | `ResetPasswordPage` | ✅ 已实现 |

### 页面跳转关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        认证模块导航流程                           │
└─────────────────────────────────────────────────────────────────┘

                        ┌─────────────┐
                        │  App 启动   │
                        └──────┬──────┘
                               │
                    ┌──────────┴──────────┐
                    │ useAuthInitialization │
                    │   检查登录状态         │
                    └──────────┬──────────┘
                               │
              ┌────────────────┴────────────────┐
              │                                 │
              ↓                                 ↓
    ┌─────────────────┐               ┌─────────────────┐
    │   已登录 ✅      │               │   未登录 ❌      │
    │                 │               │                 │
    │  → /(tabs)      │               │  访问受保护页面   │
    │    首页/发现等   │               │  显示登录提示    │
    └─────────────────┘               └────────┬────────┘
                                               │
                                               ↓
                                    ┌─────────────────┐
                                    │ /auth/login     │
                                    │ LoginMainPage   │
                                    │ 登录主页面       │
                                    └────────┬────────┘
                                             │
                    ┌────────────────────────┼────────────────────────┐
                    │                        │                        │
                    ↓                        ↓                        ↓
          ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
          │   密码登录       │    │   验证码登录     │    │   忘记密码       │
          │                 │    │                 │    │                 │
          │ 手机号 + 密码    │    │ 手机号 + 短信码  │    │ → 忘记密码页     │
          └────────┬────────┘    └────────┬────────┘    └────────┬────────┘
                   │                      │                      │
                   │                      │                      ↓
                   │                      │           ┌─────────────────┐
                   │                      │           │/auth/forgot-    │
                   │                      │           │password         │
                   │                      │           │ForgotPasswordPage│
                   │                      │           └────────┬────────┘
                   │                      │                    │
                   │                      │         ┌──────────┴──────────┐
                   │                      │         │                     │
                   │                      │         ↓                     ↓
                   │                      │  ┌─────────────┐    ┌─────────────┐
                   │                      │  │ 步骤1:输入  │    │ 步骤2:验证  │
                   │                      │  │ 手机号获取码 │    │ 验证码身份  │
                   │                      │  └──────┬──────┘    └──────┬──────┘
                   │                      │         │                  │
                   │                      │         └────────┬─────────┘
                   │                      │                  ↓
                   │                      │       ┌─────────────────┐
                   │                      │       │/auth/reset-     │
                   │                      │       │password         │
                   │                      │       │ResetPasswordPage │
                   │                      │       │ 设置新密码       │
                   │                      │       └────────┬────────┘
                   │                      │                │
                   ↓                      ↓                ↓
            ┌──────────────────────────────────────────────────┐
            │                  登录成功                         │
            │                                                  │
            │  1. authStore 更新状态                            │
            │  2. SecureStore 保存 Token                       │
            │  3. 跳转到 /(tabs) 或 returnTo 参数指定页面       │
            └──────────────────────────────────────────────────┘
```

### 详细导航说明

#### 1. 登录主页 → 其他页面

| 触发操作 | 目标页面 | 导航代码 |
|---------|---------|---------|
| 点击"忘记密码" | 忘记密码页 | `router.push('/auth/forgot-password')` |
| 登录成功 | 首页或指定页 | `router.replace(returnTo \|\| '/(tabs)')` |
| 点击用户协议 | 协议弹窗 | `Modal` |
| 点击隐私政策 | 隐私弹窗 | `Modal` |

#### 2. 忘记密码页 → 其他页面

| 触发操作 | 目标页面 | 导航代码 |
|---------|---------|---------|
| 验证码验证成功 | 重置密码页 | `router.push({ pathname: '/auth/reset-password', params: { phone, country } })` |
| 点击返回 | 登录页 | `router.back()` |

#### 3. 重置密码页 → 其他页面

| 触发操作 | 目标页面 | 导航代码 |
|---------|---------|---------|
| 密码重置成功 | 登录页 | `router.replace('/auth/login')` |
| 点击返回 | 忘记密码页 | `router.back()` |

### 外部跳入认证模块

| 来源页面 | 触发条件 | 跳转方式 |
|---------|---------|---------|
| 消息Tab | 未登录点击消息 | 页面内登录提示 → 点击登录 |
| 我的Tab | 未登录点击我的 | 页面内登录提示 → 点击登录 |
| 受保护页面 | 路由守卫拦截 | `router.push({ pathname: '/auth/login', params: { returnTo } })` |

## 🔑 核心接口

### 认证 API（后端集成）
| 接口 | 说明 | 端点 |
|------|------|------|
| `authApi.login()` | 密码/验证码登录 | POST /auth/login/password<br>POST /auth/login/sms |
| `authApi.sendLoginCode()` | 发送登录验证码 | POST /auth/sms/login |
| `authApi.refreshToken()` | 刷新访问令牌 | POST /auth/token/refresh |
| `authApi.sendResetPasswordCode()` | 发送重置密码验证码 | POST /auth/sms/reset |
| `authApi.verifyResetCode()` | 验证重置密码验证码 | POST /auth/reset/verify-code |
| `authApi.resetPassword()` | 重置密码 | POST /auth/reset/password |
| `authApi.logout()` | 登出 | POST /auth/logout |
| `authApi.getUserProfile()` | 获取用户资料 | GET /auth/user/profile |
| `authApi.checkUserExists()` | 检查用户是否存在 | POST /auth/user/exists |

### 状态管理（Zustand）
| Store | 说明 | 核心状态 |
|-------|------|---------|
| `authStore` | 认证主状态 | token, refreshToken, user, isAuthenticated |
| `authFlowStore` | 认证流程状态 | loginMode, isLoading, error |
| `authDataStore` | 认证数据状态 | phoneNumber, countryCode, password, code |
| `authUIStore` | UI 状态 | showPassword, countdown, modalVisible |

### Hooks
| Hook | 说明 | 返回值 |
|------|------|-------|
| `useAuthInitialization()` | 认证初始化 | initialized, loading, error |
| `useRouteGuard()` | 路由守卫 | isProtected, canAccess, redirectTo |
| `useLoginMainPage()` | 登录页面状态 | formData, validation, handlers |
| `useFormValidation()` | 表单验证 | phoneValid, passwordValid, codeValid, loginDisabled |
| `useCountdown()` | 倒计时 | countdown, isCountingDown, startCountdown |

## 🏛️ 架构设计

### Features 模块化架构
```
src/features/
├── AuthModule/                       # 认证模块（本模块）
│   ├── LoginMainPage/                # 登录主页面
│   │   ├── ActionButtonArea/         # ← 扁平化伪页面组件
│   │   ├── PhoneInputArea/           # ← 扁平化伪页面组件
│   │   └── ...                       # 其他伪页面组件
│   ├── api/                          # 模块级 API
│   ├── stores/                       # 模块级状态管理
│   └── hooks/                        # 模块级 Hooks
├── Homepage/                         # 首页模块
├── Messages/                         # 消息模块
└── Profile/                          # 个人中心模块
```

### 状态管理架构
```
┌─────────────────────────────────────┐
│       AuthModule 状态层              │
├─────────────────────────────────────┤
│  authStore (主状态)                  │
│  ├─ token: string                   │
│  ├─ refreshToken: string            │
│  ├─ user: UserInfo | null           │
│  └─ isAuthenticated: boolean        │
├─────────────────────────────────────┤
│  authFlowStore (流程状态)            │
│  ├─ loginMode: 'password' | 'code'  │
│  ├─ isLoading: boolean              │
│  └─ error: string | null            │
├─────────────────────────────────────┤
│  authDataStore (数据状态)            │
│  ├─ phoneNumber: string             │
│  ├─ countryCode: string             │
│  ├─ password: string                │
│  └── verificationCode: string        │
├─────────────────────────────────────┤
│  authUIStore (UI 状态)               │
│  ├─ showPassword: boolean           │
│  ├─ countdown: number               │
│  └─ modalVisible: boolean           │
└─────────────────────────────────────┘
         ↓ 持久化
┌─────────────────────────────────────┐
│   Expo SecureStore (安全存储)        │
│   ├─ token                           │
│   ├─ refreshToken                    │
│   └─ userInfo                        │
└─────────────────────────────────────┘
```

### 登录流程架构
```
┌────────────────────┐
│   LoginMainPage    │
│  (登录主页面)       │
└────────┬───────────┘
         │
    ┌────┴──────┬──────────┬──────────┐
    ↓           ↓          ↓          ↓
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│Phone    │ │Password │ │Code     │ │Action   │
│InputArea│ │InputArea│ │InputArea│ │ButtonArea
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │           │           │           │
     └───────────┴───────────┴───────────┘
                 ↓
        useLoginMainPage()
        (状态管理 Hook)
                 ↓
         ┌───────────────┐
         │  authApi      │
         │  (API 服务)    │
         └───────┬───────┘
                 ↓
         ┌───────────────┐
         │  authStore    │
         │  (全局状态)    │
         └───────┬───────┘
                 ↓
         ┌───────────────┐
         │ SecureStore   │
         │ (持久化存储)   │
         └───────────────┘
```

## 🔥 技术亮点

1. **Features 模块化**：采用 Features 架构，业务模块完整独立，包含页面、API、状态、Hooks
2. **扁平化伪页面组件**：LoginMainPage 下的 8 个功能区域组件直接位于页面层级，无 components 中间层
3. **多 Store 分离**：将认证状态拆分为 4 个独立 Store（主状态/流程/数据/UI），职责清晰
4. **路由守卫系统**：`useRouteGuard` Hook 自动检测路由权限，保护需登录的页面
5. **安全凭证管理**：使用 Expo SecureStore 加密存储 Token 和敏感信息
6. **自动 Token 刷新**：Token 过期前自动刷新，用户无感知
7. **多地区支持**：内置 +86/+1/+44 等多个国家地区，支持不同手机号格式验证
8. **API 重试机制**：网络请求失败自动重试 3 次，指数退避延迟
9. **表单验证增强**：实时验证手机号、密码、验证码格式，提供即时反馈
10. **开发调试友好**：内置 Mock API、测试账号、调试日志工具

## 🚀 快速启动

### 前置依赖
```bash
# 确保已安装 Node.js 18+ 和 Expo CLI
npm install -g expo-cli

# 安装项目依赖
cd XiangYuPai-RNExpoAPP
npm install
```

### 启动开发服务器
```bash
# 启动 Expo 开发服务器
npm start

# 或使用 Expo CLI
expo start

# 在 iOS 模拟器中运行
npm run ios

# 在 Android 模拟器中运行
npm run android
```

### 访问登录页面
```typescript
// 在 React Navigation 中导航到登录页面
import { LoginMainPage } from '@/features/AuthModule';

navigation.navigate('Login');
```

### 测试账号
```typescript
// 内置测试账号（开发环境）
手机号: 13800138000
密码: test123456
验证码: 任意 6 位数字（开发模式接受任意验证码）
```

## 📌 注意事项

### 开发环境配置
- **Mock API 模式**：开发环境默认使用 Mock API，无需后端服务即可测试
- **测试账号**：使用 `config/testAccounts.ts` 中的测试账号快速登录
- **验证码**：开发环境接受任意 6 位数字作为验证码

### 安全存储
- **Token 存储**：使用 Expo SecureStore 加密存储，不使用 AsyncStorage
- **敏感数据**：refreshToken 和用户信息同样加密存储
- **自动清理**：登出时自动清除所有存储的凭证

### 状态管理
- **多 Store 设计**：4 个 Zustand Store 分别管理不同职责
  - `authStore`：认证主状态（全局）
  - `authFlowStore`：登录流程状态（页面级）
  - `authDataStore`：表单数据状态（页面级）
  - `authUIStore`：UI 交互状态（页面级）
- **状态持久化**：仅 `authStore` 持久化到 SecureStore

### 路由守卫
- **自动保护**：使用 `useRouteGuard` Hook 自动检测需登录的路由
- **白名单配置**：在 `config/routeWhitelist.ts` 配置公开路由
- **重定向处理**：未登录用户访问保护路由自动跳转登录页

### 表单验证规则
- **手机号**：11 位数字（+86 地区），其他地区根据配置验证
- **密码**：6-20 位，不可纯数字
- **验证码**：6 位数字
- **实时验证**：输入时即时验证，按钮状态动态更新

### API 集成
- **端点配置**：在 `api/authApi.ts` 的 `API_ENDPOINTS` 配置
- **错误处理**：统一错误处理和用户友好提示
- **重试机制**：网络错误和 5xx 错误自动重试 3 次
- **超时配置**：默认 30 秒超时

### 性能优化
- **组件 memo 化**：所有功能区域组件使用 `React.memo`
- **状态局部化**：UI 状态独立管理，避免全局重渲染
- **按需导入**：使用 `index.ts` 统一导出，支持 Tree Shaking
- **懒加载**：忘记密码和重置密码页面延迟加载

### 调试工具
- **debugLogger**：在 `utils/debugLogger.ts` 中使用统一日志工具
- **测试账号打印**：运行 `config/printTestAccounts.ts` 查看所有测试账号
- **状态监控**：在 React DevTools 中查看 Zustand Store 状态

### 与后端集成
- **API 端点**：所有接口端点在 `api/authApi.ts` 中定义
- **请求格式**：参考 `types.ts` 中的 `LoginRequest`, `SendCodeRequest` 等类型
- **响应格式**：后端需返回统一的 `ApiResponse<T>` 格式
- **Token 机制**：后端需实现 JWT Token 和 Refresh Token 机制

### 国际化准备
- **多语言支持**：常量和错误消息已集中在 `constants.ts`
- **地区数据**：在 `data/countries.ts` 中维护国家地区列表
- **格式验证**：根据地区代码使用不同的手机号验证规则
